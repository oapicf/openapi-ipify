<?php

/**
 * openapi-ipify
 * PHP version 8.x
 *
 * @package OpenAPIServer
 * @author  OpenAPI Generator team
 * @link    https://github.com/openapitools/openapi-generator
 */

/**
 * OpenAPI client for ipify, a simple public IP address API
 * The version of the OpenAPI document: 5.3.1-pre.0
 * Contact: blah+oapicf@cliffano.com
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

namespace OpenAPIServer;

class RegisterRoutes {

    static public function registerRoutes(\OpenAPIServer\Api\AbstractDefaultApi $handler): void
    {
        $reflectionClass = new \ReflectionClass($handler);

        if (declaresMethod($reflectionClass, 'getIp') && declaresMethod($reflectionClass, 'getIpStream')) {
            throw new \Exception('Operation getIp cannot be both streaming and non-streaming');
        }
        if (declaresMethod($reflectionClass, 'getIp')) {
            \Flight::route('GET /', function () use ($handler) {
                $r = \Flight::request();
                $result = $handler->getIp(
                    parseParam($r->query['format'] ?? null, '?\\OpenAPIServer\\Model\\GetIpFormatParameter'),
                    parseParam($r->query['callback'] ?? null, '?string')
                );
                if ($result === null) {
                    \Flight::halt(200);
                } else {
                    \Flight::json($result, 200);
                }
            });
        }
        if (declaresMethod($reflectionClass, 'getIpStream')) {
            \Flight::route('GET /', function () use ($handler) {
                $r = \Flight::request();
                $handler->getIpStream(
                    parseParam($r->query['format'] ?? null, '?\\OpenAPIServer\\Model\\GetIpFormatParameter'),
                    parseParam($r->query['callback'] ?? null, '?string')
                );
                // ignore return value: streaming expected
            })->streamWithHeaders(['status' => 200, 'Content-Type' => 'application/json']);
        }

    }
}


function parseParam(mixed $param, string $type)
{
    $nonNullType = str_replace('?', '', $type);
    if ($param === null) {
        return null;
    } elseif ($nonNullType === 'int') {
        return intval($param);
    } elseif ($nonNullType === 'float') {
        return floatval($param);
    } elseif ($nonNullType === 'bool') {
        return filter_var($param, FILTER_VALIDATE_BOOLEAN);
    } elseif (str_ends_with($type, '[]')) {
        return array_map(fn($el) => parseParam($el, substr($type, 0, -2)), $param);
    } elseif (str_starts_with($nonNullType, '\\OpenAPIServer\\Model')) {
        if (enum_exists($nonNullType)) {
            return $nonNullType::tryFrom($param);
        }
        return $nonNullType::fromArray($param);
    } else {
        return $param;
    }
}

function declaresMethod(\ReflectionClass $reflectionClass, string $methodName): bool
{
    return $reflectionClass->hasMethod($methodName) && $reflectionClass->getMethod($methodName)->getDeclaringClass()->getName() === $reflectionClass->getName();
}
